{% extends 'base.html' %}
{% block content %}
<h3>Estimator încărcare (siguranță lombară)</h3>

<form method="post" class="row g-3">
  <div class="col-md-3">
    <label class="form-label">Greutate corporală (kg)</label>
    <input class="form-control" name="body_weight" type="number" step="0.1" required>
  </div>

  <div class="col-md-3">
    <label class="form-label">Plank – cel mai bun timp (sec)</label>
    <input class="form-control" name="plank_best" type="number" step="1" required>
  </div>

  <div class="col-md-3">
    <label class="form-label">Plank lateral – media (sec)</label>
    <input class="form-control" name="side_plank_avg" type="number" step="1" required>
  </div>

  <div class="col-md-3">
    <label class="form-label">Bird-dog – control (1–5)</label>
    <input class="form-control" name="bird_control" type="number" min="1" max="5" required>
  </div>

  <!-- ===== Durere cu ghid ===== -->
  <div class="col-md-6">
    <label class="form-label d-flex align-items-center gap-2">
      Durere lombară azi (0–10)
      <span class="badge text-bg-secondary">Ghid</span>
    </label>
    <input class="form-control" name="pain" type="number" min="0" max="10" required>
    <div class="form-text">
      <strong>0</strong> = deloc &nbsp;|&nbsp; <strong>1–2</strong> = abia sesizabilă &nbsp;|&nbsp;
      <strong>3</strong> = deranjantă, dar controlabilă &nbsp;|&nbsp;
      <strong>4–6</strong> = moderată (limitează mișcarea) &nbsp;|&nbsp;
      <strong>7–8</strong> = intensă &nbsp;|&nbsp; <strong>9–10</strong> = maximă.
      <br><em>Regulă în app: la ≥4/10, încărcările cu greutate sunt tăiate drastic; la ≥4/10 în antrenament → oprești greutățile.</em>
    </div>

    <a class="small mt-1 d-inline-block" data-bs-toggle="collapse" href="#painGuide" role="button" aria-expanded="false" aria-controls="painGuide">
      Vezi ghid detaliat de auto-evaluare
    </a>
    <div class="collapse mt-2" id="painGuide">
      <div class="card card-body small">
        <strong>Cum alegi numărul (repere funcționale):</strong>
        <ul class="mb-2">
          <li><strong>0</strong> – Nicio durere în repaus sau mișcare.</li>
          <li><strong>1–2</strong> – Disconfort ușor, îl uiți dacă te concentrezi la altceva. Mișcări zilnice normale, fără ezitare.</li>
          <li><strong>3</strong> – Simți clar disconfortul, dar poți continua toate activitățile. Nu modifici tehnica la exercițiile ușoare.</li>
          <li><strong>4</strong> – Începi să „protejezi” zona: limitezi amplitudinea sau încetinești. Aplecarea/rotirea te face precaut(ă).</li>
          <li><strong>5–6</strong> – Durere moderată: unele activități sunt evitate (ridicat obiecte, legat șireturi). Exercițiile cu încărcare agravează simptomul.</li>
          <li><strong>7–8</strong> – Durere intensă: te oprești din activitate; somnul/poziția pe scaun sunt afectate; apar „înțepături”.</li>
          <li><strong>9–10</strong> – Durere maximă: limitări majore, uneori iradiere/furnicături sau slăbiciune. Ai nevoie de pauză completă și evaluare medicală dacă persistă.</li>
        </ul>
        <strong>Repere dinamice (în timpul antrenamentului):</strong>
        <ul class="mb-2">
          <li><em>Acceptabil</em>: presiune/tensiune locală ≤3/10 care <u>nu crește</u> cu fiecare repetare și <u>dispare</u> la 24h.</li>
          <li><em>Nu accepta</em>: durere care urcă la ≥4/10, se „aprinde” la fiecare repetare, iradiază pe fesier/picior sau persistă >24–48h.</li>
        </ul>
        <strong>Semne „stop” imediate:</strong> amorțeală/înțepături pe picior, slăbiciune bruscă, pierdere de control la mișcare.
      </div>
    </div>
  </div>
  <!-- ===== End Durere cu ghid ===== -->

  <div class="col-md-3">
    <label class="form-label">Sciatic activ azi?</label>
    <select class="form-select" name="sciatic">
      <option value="0">Nu</option>
      <option value="1">Da</option>
    </select>
  </div>

  <div class="col-md-3">
    <label class="form-label">Săptămâna programului (1–4)</label>
    <input class="form-control" name="week_number" type="number" min="1" max="4" required>
  </div>

  <div class="col-md-12">
    <button class="btn btn-primary">Calculează</button>
  </div>
</form>

{% if result %}
<hr>
<div class="alert alert-success">
  <h5>Rezultate de azi</h5>
  <ul class="mb-0">
    <li>Scor „Core” (0–1): <strong>{{ '%.2f'|format(result.core_score) }}</strong></li>
    <li>Încărcare recomandată – Hinge: <strong>{{ result.hinge_kg }} kg</strong></li>
    <li>Încărcare recomandată – Goblet squat: <strong>{{ result.squat_kg }} kg</strong></li>
    <li>Prag „NU depăși” azi: <strong>{{ result.do_not_exceed }} kg</strong></li>
  </ul>
  <small class="text-muted">Oprește-te imediat dacă apare durere >3/10 sau iradiere pe picior.</small>
</div>
{% endif %}

<h5 class="mt-4">Estimări recente</h5>
<div class="table-responsive mb-4">
  <table class="table table-sm">
    <thead>
      <tr><th>Data</th><th>Core</th><th>Hinge (kg)</th><th>Squat (kg)</th><th>NU depăși (kg)</th></tr>
    </thead>
    <tbody>
      {% for e in recent %}
        <tr>
          <td>{{ e.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>{{ '%.2f'|format(e.core_score) }}</td>
          <td>{{ e.hinge_kg }}</td>
          <td>{{ e.squat_kg }}</td>
          <td>{{ e.do_not_exceed }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- TEORIE / ALGORITM -->
<div class="accordion" id="theoryAccordion">
  <div class="accordion-item">
    <h2 class="accordion-header" id="th1">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#theory" aria-expanded="true" aria-controls="theory">
        Cum funcționează estimatorul (teorie & pași de calcul)
      </button>
    </h2>
    <div id="theory" class="accordion-collapse collapse show" aria-labelledby="th1" data-bs-parent="#theoryAccordion">
      <div class="accordion-body">
        <h6>Ce estimează</h6>
        <ul>
          <li><strong>Hinge (kg)</strong> – mișcări tip îndreptări/kettlebell deadlift (dominant șold).</li>
          <li><strong>Goblet Squat (kg)</strong> – genuflexiuni goblet (dominant genunchi–șold).</li>
          <li><strong>Prag „NU depăși”</strong> – limită orientativă de siguranță pe zi.</li>
        </ul>

        <h6>Inputuri folosite</h6>
        <ol>
          <li>Greutatea corporală</li>
          <li>Plank – cel mai bun timp (sec)</li>
          <li>Plank lateral – media pe părți (sec)</li>
          <li>Bird-dog – control (1–5)</li>
          <li>Durere lombară azi (0–10)</li>
          <li>Sciatic activ? (0/1)</li>
          <li>Săptămâna programului (1–4)</li>
        </ol>

        <h6>1) Scorul „Core”</h6>
        <pre class="mb-2" style="white-space:pre-wrap">plank_norm = min(Plank / 60, 1.0)
side_norm  = min(SidePlank / 45, 1.0)
bird_norm  = min(BirdDogControl / 5, 1.0)

CoreScore  = 0.45*plank_norm + 0.35*side_norm + 0.20*bird_norm</pre>
        <small class="text-muted d-block mb-3">Ponderile favorizează rezistența anterioară (plank) și stabilitatea laterală (plank lateral), cu aport de control motor (bird-dog).</small>

        <h6>2) Factori de siguranță</h6>
        <pre class="mb-2" style="white-space:pre-wrap">pain_factor    = max(0.4, 1 - 0.07 * Durere)
sciatic_factor = 0.8  dacă Sciatic=1  altfel 1.0
week_factor    = {1:0.60, 2:0.75, 3:0.90, 4:1.00}[Săptămâna]</pre>

        <h6>3) Procente din greutatea corporală</h6>
        <pre class="mb-2" style="white-space:pre-wrap">hinge_pct = 0.20 + 0.60 * CoreScore   # 20% .. 80%
squat_pct = 0.15 + 0.45 * CoreScore   # 15% .. 60%</pre>

        <h6>4) Kilograme recomandate</h6>
        <pre class="mb-2" style="white-space:pre-wrap">Hinge_kg = Greutate * hinge_pct * pain_factor * sciatic_factor * week_factor
Squat_kg = Greutate * squat_pct * pain_factor * sciatic_factor * week_factor</pre>

        <h6>5) Prag „NU depăși”</h6>
        <pre class="mb-2" style="white-space:pre-wrap">dacă Durere ≥ 4  →  do_not_exceed = 0 kg
altfel            do_not_exceed = max(Hinge_kg, Squat_kg) * 1.10</pre>

        <h6>Exemplu numeric</h6>
        <pre class="mb-2" style="white-space:pre-wrap">Ex.: 100 kg | Plank 40s | Side plank 20s | Bird-dog 3/5 | Durere 2/10 | Sciatic 0 | Săpt. 2
CoreScore ≈ 0.57 → Hinge ≈ 34.8 kg, Squat ≈ 26.4 kg, NU depăși ≈ 38.3 kg</pre>

        <h6>Interpretare & siguranță</h6>
        <ul>
          <li>Țintele sunt <em>orientative</em> și conservatoare; tehnica fără durere are prioritate.</li>
          <li>La durere &ge; 3/10 sau simptome neurologice (amorțeală, iradiere) <strong>scade imediat</strong> încărcarea.</li>
          <li>La durere &ge; 4/10: <strong>0 kg</strong> în ziua respectivă pentru mișcări încărcate.</li>
        </ul>

        <h6>Limitări</h6>
        <p class="mb-2">Heuristic orientat pentru revenire progresivă (istoric lombalgie/sciatic). Nu ține cont încă de somn/stres/RPE/mobilitate.</p>

        <h6>Calibrare rapidă (tuning)</h6>
        <ul>
          <li>Prea ușor constant → crește ușor <code>week_factor</code> sau plafonul <code>hinge_pct</code>/<code>squat_pct</code>.</li>
          <li>Stres lombar → scade <code>hinge_pct</code> cu 0.05 și/sau crește ponderea la side plank în CoreScore.</li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}
